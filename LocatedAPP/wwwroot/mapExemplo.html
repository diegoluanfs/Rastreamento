<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Display navigation directions</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
    <!-- Header section -->
    <div class="container-fluid no-padding">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container" id="header-verify">

            </div>
        </nav>
    </div>
    <!-- Header section end -->

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" />

    <div id="map"></div>

    <script>


mapboxgl.accessToken = 'pk.eyJ1IjoiZGllZ29sdWFuZnMiLCJhIjoiY2xxZHJnOWE0MGV6MzJpcGxtdnJwY25pYyJ9.V9llMCoz-QmkNpSXxAgj8Q';
const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-53.81106, -29.69370],
            zoom: 12
});

map.addControl(
            new MapboxDirections({
                accessToken: mapboxgl.accessToken
            }),
            'top-left'
);

const locationsMax = [
            { coordinates: [-53.81106, -29.69370], name: 'Ponto 1' },
            { coordinates: [-53.68800, -29.70333], name: 'Ponto 2' },
            { coordinates: [-53.88273, -29.68726], name: 'Ponto 3' },
            { coordinates: [-53.79571, -29.74429], name: 'Ponto 4' },
            { coordinates: [-53.77534, -29.66248], name: 'Ponto 5' }
];

const routeColors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
let rotas = [];

map.on('load', async () => {
            for (let i = 0; i < locationsMax.length - 1; i++) {
                const startLocation = locationsMax[i];
                const endLocation = locationsMax[i + 1];

                new mapboxgl.Marker({ color: routeColors[i] })
                    .setLngLat(startLocation.coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML(`<h3>${startLocation.name}</h3>`))
                    .addTo(map);

                const directionsURL = 'https://api.mapbox.com/directions/v5/mapbox/driving-traffic/';
                const waypoints = `${startLocation.coordinates[0]},${startLocation.coordinates[1]};${endLocation.coordinates[0]},${endLocation.coordinates[1]}`;
                const requestURL = `${directionsURL}${waypoints}.json?geometries=geojson&steps=true&overview=full&language=en&access_token=${mapboxgl.accessToken}`;

                try {
                    const response = await axios.get(requestURL);
                    const route = response.data.routes[0].geometry;

                    rotas = rotas.concat(route.coordinates);

                    map.addLayer({
                        id: `route-${i}`,
                        type: 'line',
                        source: {
                            type: 'geojson',
                            data: {
                                type: 'Feature',
                                properties: {},
                                geometry: route
                            }
                        },
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': routeColors[i],
                            'line-width': 8
                        }
                    });

                    const carMarker = new mapboxgl.Marker({
                        color: routeColors[i]
                    })
                        .setLngLat(startLocation.coordinates)
                        .addTo(map);

                    let prevLng = startLocation.coordinates[0];
                    let prevLat = startLocation.coordinates[1];

                    setInterval(() => {
                        if (rotas.length > 0) {
                            const [lng, lat] = rotas.shift();
                            carMarker.setLngLat([lng, lat]);

                            const distance = calculateDistance(prevLng, prevLat, lng, lat);
                            if (distance > 0.001) {
                                console.log(`O carro moveu-se uma distância de:[${distance}]  Nova posição: [${lng}, ${lat}]`);
                            }

                            prevLng = lng;
                            prevLat = lat;
                        }
                    }, 1000);
                } catch (error) {
                    console.error(`Error fetching directions for route ${i}:`, error);
                }
            }

            const lastLocation = locationsMax[locationsMax.length - 1];
            new mapboxgl.Marker({ color: routeColors[routeColors.length - 1] })
                .setLngLat(lastLocation.coordinates)
                .setPopup(new mapboxgl.Popup().setHTML(`<h3>${lastLocation.name}</h3>`))
                .addTo(map);
});

function calculateDistance(lon1, lat1, lon2, lat2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance;
}
    </script>
</body>
</html>