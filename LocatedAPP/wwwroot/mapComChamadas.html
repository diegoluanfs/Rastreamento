<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Display navigation directions</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header section -->
    <div class="container-fluid no-padding">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container" id="header-verify">

            </div>
        </nav>
    </div>
    <!-- Header section end -->

    <div id="map"></div>

    <script>
        var url_base = 'http://localhost:5291';
        var valorArmazenado = localStorage.getItem('Token-Located');
        var locationsMax = [];

        ACCESS_TOKEN_MAPBOX = 'pk.eyJ1IjoiZGllZ29sdWFuZnMiLCJhIjoiY2xxZHJnOWE0MGV6MzJpcGxtdnJwY25pYyJ9.V9llMCoz-QmkNpSXxAgj8Q';

        if (valorArmazenado) {
            mapboxgl.accessToken = ACCESS_TOKEN_MAPBOX;

            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [-53.81106, -29.69370],
                zoom: 12,
                interactive: true
            });

            GetTargets().then(function (result) {
                if (Array.isArray(result) && result.length > 0) {
                    result.forEach(function (item) {
                        var locationStart = {
                            coordinates: [item.latitudeStart, item.longitudeStart],
                            name: 'Ponto ' + item.id,
                            color: item.color
                        };

                        var locationEnd = {
                            coordinates: [item.latitudeEnd, item.longitudeEnd],
                            name: 'Ponto ' + item.id,
                            color: item.color
                        };

                        locationsMax.push(locationStart);
                        locationsMax.push(locationEnd);
                    });
                } else {
                    console.log('A lista está vazia ou não é um array.');
                }

                console.log("locationsMax: ", locationsMax);
                let rotas = [];

                map.on('load', () => {
                    for (let i = 0; i < locationsMax.length; i++) {
                        const location = locationsMax[i];

                        new mapboxgl.Marker({ color: location.color })
                            .setLngLat([location.coordinates[0], location.coordinates[1]])
                            .setPopup(new mapboxgl.Popup().setHTML(`<h3>${location.name}</h3>`))
                            .addTo(map);
                    }

                    for (let i = 0; i < locationsMax.length; i += 2) {
                        const startLocation = locationsMax[i];
                        const endLocation = locationsMax[i + 1];

                        const coordinates = [startLocation.coordinates, endLocation.coordinates];

                        map.addSource(`route-${i}`, {
                            'type': 'geojson',
                            'data': {
                                'type': 'Feature',
                                'properties': {},
                                'geometry': {
                                    'type': 'LineString',
                                    'coordinates': coordinates
                                }
                            }
                        });

                        map.addLayer({
                            'id': `route-${i}`,
                            'type': 'line',
                            'source': `route-${i}`,
                            'layout': {
                                'line-join': 'round',
                                'line-cap': 'round'
                            },
                            'paint': {
                                'line-color': startLocation.color,
                                'line-width': 2
                            }
                        });

                        axios.get(`https://api.mapbox.com/directions/v5/mapbox/driving/${coordinates[0][0]},${coordinates[0][1]};${coordinates[1][0]},${coordinates[1][1]}`, {
                            params: {
                                steps: true,
                                geometries: 'geojson',
                                accessToken: ACCESS_TOKEN_MAPBOX
                            }
                        }).then(response => {
                            const route = response.data.routes[0];
                            const routeCoordinates = route.geometry.coordinates;

                            map.addSource(`route-steps-${i}`, {
                                'type': 'geojson',
                                'data': {
                                    'type': 'Feature',
                                    'properties': {},
                                    'geometry': {
                                        'type': 'LineString',
                                        'coordinates': routeCoordinates
                                    }
                                }
                            });

                            map.addLayer({
                                'id': `route-steps-${i}`,
                                'type': 'line',
                                'source': `route-steps-${i}`,
                                'layout': {
                                    'line-join': 'round',
                                    'line-cap': 'round'
                                },
                                'paint': {
                                    'line-color': startLocation.color,
                                    'line-width': 2
                                }
                            });
                        }).catch(error => {
                            console.error(error);
                        });
                    }
                });
            }).catch(function (error) {
                console.error(error);
            });

        } else {
            console.log("não existe token")
        }

        function GetTargets() {
            return new Promise(function (resolve, reject) {
                var token = localStorage.getItem('Token-Located');

                var headers = {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                };

                $.ajax({
                    url: url_base + '/api/targets',
                    type: 'GET',
                    headers: headers,
                    success: function (result) {
                        resolve(result);
                    },
                    error: function (error) {
                        reject(error);
                        Swal.fire({
                            position: "top-end",
                            icon: "error",
                            title: error.responseJSON.message,
                            showConfirmButton: false,
                            timer: 2500
                        });
                    }
                });
            });
        }
    </script>
</body>

</html>
