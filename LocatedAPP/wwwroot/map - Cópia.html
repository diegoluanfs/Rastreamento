<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags -->
    <meta charset="utf-8">
    <title>Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Mapbox CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">

    <!-- Mapbox and dependencies scripts -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- SweetAlert2 for displaying pop-up messages -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- jQuery -->
    <script src="js/jquery-3.2.1.min.js"></script>

    <!-- Mapbox Directions Plugin -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header section -->
    <div class="container-fluid no-padding">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container" id="header-verify">

            </div>
        </nav>
    </div>
    <!-- Header section end -->

    <!-- Map container -->
    <div id="map"></div>

    <script src="./js/script.js"></script>
    <!-- JavaScript code -->
    <script>
        // Base URL for API requests
        var url_base = 'http://localhost:5291';

        // Retrieve token from local storage
        var valorArmazenado = localStorage.getItem('Token-Located');

        // Array to store location data
        var locationsMax = [];

        // Mapbox access token
        ACCESS_TOKEN_MAPBOX = 'pk.eyJ1IjoiZGllZ29sdWFuZnMiLCJhIjoiY2xxZHJnOWE0MGV6MzJpcGxtdnJwY25pYyJ9.V9llMCoz-QmkNpSXxAgj8Q';

        if (valorArmazenado) {
            // Set Mapbox access token
            mapboxgl.accessToken = ACCESS_TOKEN_MAPBOX;

            // Create Mapbox map
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [-53.81106, -29.69370],
                zoom: 12,
                interactive: true
            });

            // Add Mapbox Directions control to the map
            //map.addControl(
            //    new MapboxDirections({
            //        accessToken: mapboxgl.accessToken
            //    }),
            //    'top-left'
            //);

            // Fetch targets and process the result
            GetTargets().then(function (result) {
                // Check if the result is an array and not empty
                if (Array.isArray(result) && result.length > 0) {
                    result.forEach(function (item) {
                        // Create start location object
                        var locationStart = {
                            coordinates: [item.latitudeStart, item.longitudeStart],
                            name: 'Ponto ' + item.id,
                            color: item.color
                        };

                        // Create end location object
                        var locationEnd = {
                            coordinates: [item.latitudeEnd, item.longitudeEnd],
                            name: 'Ponto ' + item.id,
                            color: item.color
                        };

                        // Add locations to the array
                        locationsMax.push(locationStart);
                        locationsMax.push(locationEnd);
                    });
                } else {
                    console.log('A lista está vazia ou não é um array.');
                }

                // After the map loads
                map.on('load', () => {
                    // Add markers to the map
                    for (let i = 0; i < locationsMax.length; i++) {
                        const location = locationsMax[i];

                        new mapboxgl.Marker({ color: location.color })
                            .setLngLat([location.coordinates[0], location.coordinates[1]])
                            .setPopup(new mapboxgl.Popup().setHTML(`<h3>${location.name}</h3>`))
                            .addTo(map);
                    }

                    // Add routes and directions to the map
                    for (let i = 0; i < locationsMax.length; i += 2) {
                        const startLocation = locationsMax[i];
                        const endLocation = locationsMax[i + 1];

                        const coordinates = [startLocation.coordinates, endLocation.coordinates];

                        // Request optimized route directions from Mapbox
                        axios.get(`https://api.mapbox.com/directions/v5/mapbox/driving/${coordinates[0][0]},${coordinates[0][1]};${coordinates[1][0]},${coordinates[1][1]}`, {
                            params: {
                                steps: true,
                                geometries: 'geojson',
                                overview: 'full',
                                language: 'en',
                                access_token: ACCESS_TOKEN_MAPBOX
                            }
                        }).then(response => {
                            // Process the route response
                            const route = response.data.routes[0];
                            const routeCoordinates = route.geometry.coordinates;

                            // Add route source to the map
                            map.addSource(`route-${i}`, {
                                'type': 'geojson',
                                'data': {
                                    'type': 'Feature',
                                    'properties': {},
                                    'geometry': {
                                        'type': 'LineString',
                                        'coordinates': routeCoordinates
                                    }
                                }
                            });

                            // Add route layer to the map
                            map.addLayer({
                                'id': `route-${i}`,
                                'type': 'line',
                                'source': `route-${i}`,
                                'layout': {
                                    'line-join': 'round',
                                    'line-cap': 'round'
                                },
                                'paint': {
                                    'line-color': startLocation.color,
                                    'line-width': 2
                                }
                            });

                            // Add route steps source to the map
                            map.addSource(`route-steps-${i}`, {
                                'type': 'geojson',
                                'data': {
                                    'type': 'Feature',
                                    'properties': {},
                                    'geometry': {
                                        'type': 'LineString',
                                        'coordinates': routeCoordinates
                                    }
                                }
                            });

                            // Add route steps layer to the map
                            map.addLayer({
                                'id': `route-steps-${i}`,
                                'type': 'line',
                                'source': `route-steps-${i}`,
                                'layout': {
                                    'line-join': 'round',
                                    'line-cap': 'round'
                                },
                                'paint': {
                                    'line-color': startLocation.color,
                                    'line-width': 2
                                }
                            });

                        }).catch(error => {
                            console.error(error);
                        });
                    }
                });


            }).catch(function (error) {
                console.error(error);
            });

        } else {
            console.log("não existe token")
        }

        // Function to fetch targets
        function GetTargets() {
            return new Promise(function (resolve, reject) {
                // Retrieve token from local storage
                var token = localStorage.getItem('Token-Located');

                // Headers for the API request
                var headers = {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                };

                // AJAX request to fetch targets
                $.ajax({
                    url: url_base + '/api/targets',
                    type: 'GET',
                    headers: headers,
                    success: function (result) {
                        resolve(result);
                    },
                    error: function (error) {
                        reject(error);
                        // Display an error message using SweetAlert2
                        Swal.fire({
                            position: "top-end",
                            icon: "error",
                            title: error.responseJSON.message,
                            showConfirmButton: false,
                            timer: 2500
                        });
                    }
                });
            });
        }
    </script>

</body>

</html>
